<div class="row">
    <!-- Total Revenue -->
    <div class="col-12 col-lg-8 order-2 order-md-3 order-lg-2 mb-4">
        <div class="card h-100">
            <div class="row row-bordered g-0">
                <div class="col-md-8">
                    <h5 class="card-header m-0 me-2 pb-3">Total Revenue</h5>
                    <div id="totalRevenueChart" class="px-2"></div>
                </div>
                <div class="col-md-4">
                    <div class="card-body">
                        <div class="text-center">
                            <div class="dropdown">
                                <button class="btn btn-sm btn-outline-primary dropdown-toggle" type="button"
                                    id="growthReportId" data-bs-toggle="dropdown" aria-haspopup="true"
                                    aria-expanded="false">
                                    2022
                                </button>
                                <div class="dropdown-menu dropdown-menu-end" aria-labelledby="growthReportId">
                                    <a class="dropdown-item" href="javascript:void(0);">2021</a>
                                    <a class="dropdown-item" href="javascript:void(0);">2020</a>
                                    <a class="dropdown-item" href="javascript:void(0);">2019</a>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="growthChart"></div>
                    <div class="text-center fw-semibold pt-3 mb-2">62% Company Growth</div>

                    <div class="d-flex px-xxl-4 px-lg-2 p-4 gap-xxl-3 gap-lg-1 gap-3 justify-content-between">
                        <div class="d-flex">
                            <div class="me-2">
                                <span class="badge bg-label-primary p-2"><i
                                        class="bx bx-dollar text-primary"></i></span>
                            </div>
                            <div class="d-flex flex-column">
                                <small>2022</small>
                                <h6 class="mb-0">$32.5k</h6>
                            </div>
                        </div>
                        <div class="d-flex">
                            <div class="me-2">
                                <span class="badge bg-label-info p-2"><i class="bx bx-wallet text-info"></i></span>
                            </div>
                            <div class="d-flex flex-column">
                                <small>2021</small>
                                <h6 class="mb-0">$41.2k</h6>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Order Statistics -->
    <div class="col-md-6 col-lg-4 col-xl-4 order-0 mb-4">
        <div class="card h-100">
            <div class="card-header d-flex align-items-center justify-content-between pb-0">
                <div class="card-title mb-0">
                    <h5 class="m-0 me-2">Actividades</h5>
                    <small class="text-muted"></small>
                </div>
                <div class="dropdown">
                    <button class="btn p-0" type="button" id="orederStatistics" data-bs-toggle="dropdown"
                        aria-haspopup="true" aria-expanded="false">
                        <i class="bx bx-dots-vertical-rounded"></i>
                    </button>
                    <div class="dropdown-menu dropdown-menu-end" aria-labelledby="orederStatistics">
                        <a class="dropdown-item" href="javascript:void(0);">Select All</a>
                        <a class="dropdown-item" href="javascript:void(0);">Refresh</a>
                        <a class="dropdown-item" href="javascript:void(0);">Share</a>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div class="d-flex flex-column align-items-center gap-1">
                        <h2 class="mb-2">{{ total_actividades }}</h2>
                        <span>Total Actividades</span>
                    </div>
                    <div id="orderStatisticsChart"></div>
                </div>
                <ul class="p-0 m-0">
                    <li class="d-flex mb-4 pb-1">
                        <div class="avatar flex-shrink-0 me-3">
                            <span class="avatar-initial rounded bg-warning"> <!-- Color amarillo -->
                                <i class="bx bx-time-five"></i> <!-- Ícono para actividades pendientes -->
                            </span>
                        </div>
                        <div class="d-flex w-100 flex-wrap align-items-center justify-content-between gap-2">
                            <div class="me-2">
                                <h6 class="mb-0">Pendientes</h6>
                                <small class="text-muted">...</small>
                            </div>
                            <div class="user-progress">
                                <small class="fw-semibold">{{actividades_pendientes }}</small>
                            </div>
                        </div>
                    </li>
                    <li class="d-flex mb-4 pb-1">
                        <div class="avatar flex-shrink-0 me-3">
                            <span class="avatar-initial rounded bg-secondary"> <!-- Color gris -->
                                <i class="bx bx-loader-circle"></i> 
                            </span>
                        </div>
                        <div class="d-flex w-100 flex-wrap align-items-center justify-content-between gap-2">
                            <div class="me-2">
                                <h6 class="mb-0">En Proceso</h6>
                                <small class="text-muted">...</small>
                            </div>
                            <div class="user-progress">
                                <small class="fw-semibold">{{actividades_proceso }}</small>
                            </div>
                        </div>
                    </li>
                    <li class="d-flex mb-4 pb-1">
                        <div class="avatar flex-shrink-0 me-3">
                            <span class="avatar-initial rounded bg-success"> 
                                <i class="bx bx-task"></i> 
                            </span>
                        </div>
                        
                        <div class="d-flex w-100 flex-wrap align-items-center justify-content-between gap-2">
                            <div class="me-2">
                                <h6 class="mb-0">Finalizadas</h6>
                                <small class="text-muted">...</small>
                            </div>
                            <div class="user-progress">
                                <small class="fw-semibold">{{actividades_finalizadas}}</small>
                            </div>
                        </div>
                    </li>
                    
                </ul>
            </div>
        </div>
    </div>
    <!--/ Order Statistics -->
</div>
<div class="row">
    

    <!-- Expense Overview -->
    <div class="col-md-6 col-lg-4 order-1 mb-4">
        <div class="card h-100">
            <div class="card-header">
                <ul class="nav nav-pills" role="tablist">
                    <li class="nav-item">
                        <button type="button" class="nav-link active" role="tab" data-bs-toggle="tab"
                            data-bs-target="#navs-tabs-line-card-income" aria-controls="navs-tabs-line-card-income"
                            aria-selected="true">
                            Income
                        </button>
                    </li>
                    <li class="nav-item">
                        <button type="button" class="nav-link" role="tab">Expenses</button>
                    </li>
                    <li class="nav-item">
                        <button type="button" class="nav-link" role="tab">Profit</button>
                    </li>
                </ul>
            </div>
            <div class="card-body px-0">
                <div class="tab-content p-0">
                    <div class="tab-pane fade show active" id="navs-tabs-line-card-income" role="tabpanel">
                        <div class="d-flex p-4 pt-3">
                            <div class="avatar flex-shrink-0 me-3">
                                <img src="../assets/img/icons/unicons/wallet.png" alt="User" />
                            </div>
                            <div>
                                <small class="text-muted d-block">Total Balance</small>
                                <div class="d-flex align-items-center">
                                    <h6 class="mb-0 me-1">$459.10</h6>
                                    <small class="text-success fw-semibold">
                                        <i class="bx bx-chevron-up"></i>
                                        42.9%
                                    </small>
                                </div>
                            </div>
                        </div>
                        <div id="incomeChart"></div>
                        <div class="d-flex justify-content-center pt-4 gap-2">
                            <div class="flex-shrink-0">
                                <div id="expensesOfWeek"></div>
                            </div>
                            <div>
                                <p class="mb-n1 mt-1">Expenses This Week</p>
                                <small class="text-muted">$39 less than last week</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!--/ Expense Overview -->

    <!-- Transactions -->
    <div class="col-md-6 col-lg-4 order-2 mb-4">
        <div class="card h-100">
            <div class="card-header d-flex align-items-center justify-content-between">
                <h5 class="card-title m-0 me-2">Transactions</h5>
                <div class="dropdown">
                    <button class="btn p-0" type="button" id="transactionID" data-bs-toggle="dropdown"
                        aria-haspopup="true" aria-expanded="false">
                        <i class="bx bx-dots-vertical-rounded"></i>
                    </button>
                    <div class="dropdown-menu dropdown-menu-end" aria-labelledby="transactionID">
                        <a class="dropdown-item" href="javascript:void(0);">Last 28 Days</a>
                        <a class="dropdown-item" href="javascript:void(0);">Last Month</a>
                        <a class="dropdown-item" href="javascript:void(0);">Last Year</a>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <ul class="p-0 m-0">
                    <li class="d-flex mb-4 pb-1">
                        <div class="avatar flex-shrink-0 me-3">
                            <img src="../assets/img/icons/unicons/paypal.png" alt="User" class="rounded" />
                        </div>
                        <div class="d-flex w-100 flex-wrap align-items-center justify-content-between gap-2">
                            <div class="me-2">
                                <small class="text-muted d-block mb-1">Paypal</small>
                                <h6 class="mb-0">Send money</h6>
                            </div>
                            <div class="user-progress d-flex align-items-center gap-1">
                                <h6 class="mb-0">+82.6</h6>
                                <span class="text-muted">USD</span>
                            </div>
                        </div>
                    </li>
                    <li class="d-flex mb-4 pb-1">
                        <div class="avatar flex-shrink-0 me-3">
                            <img src="../assets/img/icons/unicons/wallet.png" alt="User" class="rounded" />
                        </div>
                        <div class="d-flex w-100 flex-wrap align-items-center justify-content-between gap-2">
                            <div class="me-2">
                                <small class="text-muted d-block mb-1">Wallet</small>
                                <h6 class="mb-0">Mac'D</h6>
                            </div>
                            <div class="user-progress d-flex align-items-center gap-1">
                                <h6 class="mb-0">+270.69</h6>
                                <span class="text-muted">USD</span>
                            </div>
                        </div>
                    </li>
                    <li class="d-flex mb-4 pb-1">
                        <div class="avatar flex-shrink-0 me-3">
                            <img src="../assets/img/icons/unicons/chart.png" alt="User" class="rounded" />
                        </div>
                        <div class="d-flex w-100 flex-wrap align-items-center justify-content-between gap-2">
                            <div class="me-2">
                                <small class="text-muted d-block mb-1">Transfer</small>
                                <h6 class="mb-0">Refund</h6>
                            </div>
                            <div class="user-progress d-flex align-items-center gap-1">
                                <h6 class="mb-0">+637.91</h6>
                                <span class="text-muted">USD</span>
                            </div>
                        </div>
                    </li>
                    <li class="d-flex mb-4 pb-1">
                        <div class="avatar flex-shrink-0 me-3">
                            <img src="../assets/img/icons/unicons/cc-success.png" alt="User" class="rounded" />
                        </div>
                        <div class="d-flex w-100 flex-wrap align-items-center justify-content-between gap-2">
                            <div class="me-2">
                                <small class="text-muted d-block mb-1">Credit Card</small>
                                <h6 class="mb-0">Ordered Food</h6>
                            </div>
                            <div class="user-progress d-flex align-items-center gap-1">
                                <h6 class="mb-0">-838.71</h6>
                                <span class="text-muted">USD</span>
                            </div>
                        </div>
                    </li>
                    <li class="d-flex mb-4 pb-1">
                        <div class="avatar flex-shrink-0 me-3">
                            <img src="../assets/img/icons/unicons/wallet.png" alt="User" class="rounded" />
                        </div>
                        <div class="d-flex w-100 flex-wrap align-items-center justify-content-between gap-2">
                            <div class="me-2">
                                <small class="text-muted d-block mb-1">Wallet</small>
                                <h6 class="mb-0">Starbucks</h6>
                            </div>
                            <div class="user-progress d-flex align-items-center gap-1">
                                <h6 class="mb-0">+203.33</h6>
                                <span class="text-muted">USD</span>
                            </div>
                        </div>
                    </li>
                    <li class="d-flex">
                        <div class="avatar flex-shrink-0 me-3">
                            <img src="../assets/img/icons/unicons/cc-warning.png" alt="User" class="rounded" />
                        </div>
                        <div class="d-flex w-100 flex-wrap align-items-center justify-content-between gap-2">
                            <div class="me-2">
                                <small class="text-muted d-block mb-1">Mastercard</small>
                                <h6 class="mb-0">Ordered Food</h6>
                            </div>
                            <div class="user-progress d-flex align-items-center gap-1">
                                <h6 class="mb-0">-92.45</h6>
                                <span class="text-muted">USD</span>
                            </div>
                        </div>
                    </li>
                </ul>
            </div>
        </div>
    </div>
    <!--/ Transactions -->
</div>

<!-- Gráficos de Actividades por Categoría -->
<h2 class="my-4">Actividades por Categoría</h2>
<div class="row">
    {% for categoria in actividades_por_categoria %}
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">{{ categoria.tipo__nombre }}</h5>
                <div class="progress mb-2">
                    <div class="progress-bar bg-success"
                        style="width: {{ categoria.finalizadas_pct }}%">Finalizadas</div>
                </div>
                <div class="progress mb-2">
                    <div class="progress-bar bg-warning"
                        style="width: {{ categoria.en_proceso_pct }}%">En Proceso</div>
                </div>
                <div class="progress mb-2">
                    <div class="progress-bar bg-danger"
                        style="width: {{ categoria.pendientes_pct }}%">Pendientes</div>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
</div>


<div class="container">
    <h2>Distribución de Actividades por Tipo</h2>
    <div id="actividadesPorTipoChart" style="max-width: 700px; margin: 0 auto;"></div>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        var options = {
            chart: {
                type: 'bar', // Usa 'bar' para barras horizontales o 'column' para columnas verticales
                height: 400,
                toolbar: {
                    show: true
                },
                dropShadow: {
                    enabled: true,
                    opacity: 0.15,
                    blur: 5
                }
            },
            title: {
                text: 'Actividades por Tipo de Actividad',
                align: 'center',
                style: {
                    fontSize: '20px',
                    color: '#333'
                }
            },
            series: [{
                name: 'Número de Actividades',
                data: {
                    {
                        actividad_counts | safe
                    }
                }
            }],
            xaxis: {
                categories: {
                    {
                        tipo_labels | safe
                    }
                },
                title: {
                    text: 'Tipos de Actividad',
                    style: {
                        fontSize: '14px',
                        color: '#333'
                    }
                },
                labels: {
                    style: {
                        fontSize: '12px',
                        colors: ['#333']
                    }
                }
            },
            yaxis: {
                title: {
                    text: 'Número de Actividades',
                    style: {
                        fontSize: '14px',
                        color: '#333'
                    }
                },
                labels: {
                    style: {
                        fontSize: '12px',
                        colors: ['#333']
                    }
                }
            },
            colors: ['#007bff'],
            dataLabels: {
                enabled: true,
                style: {
                    colors: ['#333'],
                    fontWeight: 'bold'
                }
            },
            plotOptions: {
                bar: {
                    borderRadius: 4, // Bordes redondeados
                    horizontal: false, // Cambiar a true si prefieres barras horizontales
                    distributed: true // Colores diferentes por cada categoría
                }
            },
            legend: {
                position: 'top'
            },
            tooltip: {
                theme: 'light',
                y: {
                    formatter: function(val) {
                        return val + " actividades";
                    }
                }
            }
        };
        var chart = new ApexCharts(document.querySelector("#actividadesPorTipoChart"), options);
        chart.render();
    });
</script>



@login_required
def listar_actividad(request):
    user = request.user
    permissions = get_user_permissions(user)
    
    
    # Obtener los filtros desde el formulario
    mes = request.GET.get('mes')
    dia = request.GET.get('dia')
    orden = request.GET.get('orden', 'asc')  # Por defecto ascendente

    # Verificar si el usuario pertenece al grupo "Director"
    if user.groups.filter(name="Director").exists():
        actividades = Actividad.objects.filter(creado_por__perfilusuario__programa=user.perfilusuario.programa).distinct()
    else:
        # Si no es director, solo puede ver actividades creadas por él o en las que es colaborador
        actividades = Actividad.objects.filter(Q(creado_por=user) | Q(colaborador=user)).distinct()

    # Filtrar por mes si se ha seleccionado un mes
    if mes:
        actividades = actividades.filter(fecha_inicio__month=mes)

    # Filtrar por día si se ha seleccionado un día
    if dia:
        actividades = actividades.filter(fecha_inicio__day=dia)

    # Ordenar las actividades por la fecha de inicio
    if orden == 'asc':
        actividades = actividades.order_by('fecha_inicio')
    else:
        actividades = actividades.order_by('-fecha_inicio')
    # Para cada actividad, determinar si el usuario es el creador o colaborador
    for actividad in actividades:
        actividad.es_creador = actividad.creado_por == user
        actividad.es_colaborador = actividad.colaborador.filter(id=user.id).exists()
        actividad_colaboradores_ids = actividad.colaborador.values_list('id', flat=True)
        actividad.colaboradores_ids = list(actividad_colaboradores_ids)
        actividad.verificar_informes()
        
    paginator = Paginator(actividades,20) 
    page_number = request.GET.get('page')
    page_obj = paginator.get_page(page_number)
    
    

    # Generar la lista de días
    dias = list(range(1, 32))
    # Crear una instancia del formulario para agregar nuevas actividades
    form_actividad = ActividadForm()  
    context = {
        'actividades': page_obj.object_list,
        'form_actividad': form_actividad,
        'dias': dias,
        'page_obj': page_obj,
        **permissions  # Desempaquetar el diccionario de permisos
    }
    return render(request, 'actividades/listar_actividad.html', context)



    
